#!/usr/bin/env ruby
# frozen_string_literal: true

require 'bundler'

def list_gem_files
  decidims = Bundler.load.specs.select { |dep| dep.name.include?("decidim") }
  decidims.map do |spec|
    Dir.glob("#{spec.full_gem_path}/{app,lib,spec}/**/*").select { |file| File.file?(file) }
  end.flatten
end

def current_files
    Dir.glob("{app,lib,spec}/**/*").select { |file| File.file?(file) }.flatten
end

overrides = {}
current_files.each do |file|
  list_gem_files.each do |gem_file|
    next unless gem_file.include?(file)

    if overrides[file].nil?
      overrides[file] = [gem_file]
    else
      overrides[file] << gem_file
    end
  end
end

overrides.each do |app_file, gem_files|
  # puts "Override detected in #{app_file}"
  # puts "  #{gem_files.join("\n  ")}"
  FileUtils.cp_r gem_files.first, app_file, remove_destination: true
end

puts "###########################################"
puts "terminated..."

puts "Found #{overrides.count} overrides"
puts "###########################################"
